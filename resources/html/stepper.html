<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>System configuration</title>
        <link href="style.css" rel="stylesheet" type="text/css" />
    </head>

    <body>

        <h1 id="test">Stepper configuration</h1>

        <h2>Connexion</h2>
        <label for="port">Port :</label>
        <select id="port" name="port"></select>
        <button id="connect" onclick="connect()">Connect</button>
        <button id="disconnect" onclick="disconnect()">Disconnect</button>
        <button id="refresh" onclick="refresh()">Refresh</button>

        <h2>Select a motor</h2>
        <input type="radio" id="motor1" name="motor" value="1" checked>
        <label for="motor1">Motor 1</label>
        <input type="radio" id="motor2" name="motor" value="2">
        <label for="motor2">Motor 2</label>

        <h2>Constant speed command</h2>
        <label for="runDirection">Direction</label>
        <select id="runDirection" name="runDirection" list="direction" value="FORWARD">
            <option value="FORWARD">FORWARD</option>
            <option value="BACKWARD">BACKWARD</option>
        </select>
        <label for="runSpeed">Speed</label>
        <input id="runSpeed" name="runSpeed" type="number" min="0" max="10000" value="200">
        <button onclick="cmdRun()">RUN</button>

        <h2>Relative move command</h2>
        <label for="moveRelativeStep">Steps</label>
        <input id="moveRelativeStep" name="moveRelativeStep" type="number" min="-100000" max="100000" value="0">
        <button onclick="cmdMoveRelative()">MOVE RELATIVE</button>

        <h2>Absolute speed command</h2>
        <label for="moveAbsoluteStep">Steps</label>
        <input id="moveAbsoluteStep" name="moveAbsoluteStep" type="number" min="0" max="100000" value="0">
        <button onclick="cmdMoveAbsolute()">MOVE ABSOLUTE</button>

        <h2>Homing command</h2>
        <button onclick="cmdHoming()">HOMING</button>

        <h2>Stop command</h2>
        <button onclick="cmdStop()">STOP</button>

    </body>

    <script type="text/javascript">
        
        const vscode = acquireVsCodeApi();

        // By default disconnect is hidden
        document.getElementById("disconnect").style.display = "none";

        window.addEventListener('message', event => {
            switch(event.data.command) {
                case 'connect':
                    if (event.data.response === true) {
                        document.getElementById("connect").style.display = "none";
                        document.getElementById("disconnect").style.display = "inline";
                    }
                    break;
                case 'disconnect':
                    // If data.response is true OR false, display connect button anyway
                    document.getElementById("connect").style.display = "inline";
                    document.getElementById("disconnect").style.display = "none";
                    break;
                case 'list':
                    let select_port = document.getElementById("port");
                    select_port.replaceChildren(); // delete existing options
                    console.log(event.data.response);
                    for (port of event.data.response) {
                        console.log(port);
                        let opt = document.createElement('option');
                        opt.value = port.port;
                        opt.innerHTML = port.port + " - OIStepper nÂ°" + port.serialNum;
                        select_port.appendChild(opt);
                    }
                    break;
                case 'cmd':
                    break;
            }
        });
        
        function connect() {
            let port = document.getElementById("port").value;
            vscode.postMessage({
                command: 'connect',
                portName: port
            });
        }

        function disconnect() {
            vscode.postMessage({
                command: 'disconnect'
            });
        }

        function refresh() {
            vscode.postMessage({
                command: 'list'
            });
        }

        function cmdRun(args) {
            let motor = document.querySelector('input[name="motor"]:checked').value;
            let direction = document.getElementById('runDirection').value;
            let speed = document.getElementById('runSpeed').value;
            vscode.postMessage({
                command: 'cmd',
                args: ['run', motor, direction==="FORWARD"?"1":"0", speed]
            });
        }

        function cmdMoveRelative(args) {
            let motor = document.querySelector('input[name="motor"]:checked').value;
            let steps = document.getElementById('moveRelativeStep').value;
            vscode.postMessage({
                command: 'cmd',
                args: ['move-relative', motor, steps]
            });
        }

        function cmdMoveAbsolute(args) {
            let motor = document.querySelector('input[name="motor"]:checked').value;
            let steps = document.getElementById('moveAbsoluteStep').value;
            vscode.postMessage({
                command: 'cmd',
                args: ['move-absolute', motor, steps]
            });
        }

        function cmdStop(args) {
            let motor = document.querySelector('input[name="motor"]:checked').value;
            vscode.postMessage({
                command: 'cmd',
                args: ['stop', motor]
            });
        }


    </script>
</html>